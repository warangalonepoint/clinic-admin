<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Patient Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
    }
    h2 {
      color: #00e676;
    }
    .clinic-info {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-size: 16px;
    }
    label, select {
      display: block;
      margin: 12px 0 6px;
    }
    select, input, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      width: 100%;
    }
    button {
      background-color: #1f88e5;
      color: #fff;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background-color: #1565c0;
    }
    .slot-list {
      margin-top: 20px;
    }
    .slot-item {
      background: #222;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <script>
    const clinic = localStorage.getItem("activeClinic");
    const pin = localStorage.getItem("userPIN");
    if (!clinic || !pin) {
      alert("Access denied. Please log in.");
      window.location.href = "index.html";
    }
  </script>

  <h2>Book an Appointment</h2>
  <div class="clinic-info">üè• Active Clinic: <span id="clinicName"></span></div>

  <label for="dateSelect">Choose Date:</label>
  <select id="dateSelect" onchange="loadSlots()">
    <option value="">Select Date</option>
    <option value="Today">Today</option>
    <option value="Tomorrow">Tomorrow</option>
  </select>

  <div class="slot-list" id="slotList"></div>

  <script>
    document.getElementById("clinicName").innerText = clinic;

    const slotsURL = "https://warangalonepoint.github.io/clinic-admin/Slots.csv";
    const logsURL = "https://warangalonepoint.github.io/clinic-admin/logs.csv";

    let allSlots = [];
    let bookedSlots = [];

    function loadCSV(url, callback) {
      fetch(url)
        .then(res => res.text())
        .then(data => callback(Papa.parse(data, { header: true }).data));
    }

    function loadSlots() {
      const selectedDate = document.getElementById("dateSelect").value;
      if (!selectedDate) return;

      document.getElementById("slotList").innerHTML = "Loading slots...";
      
      loadCSV(slotsURL, slotsData => {
        allSlots = slotsData.filter(slot =>
          slot.Date === selectedDate &&
          slot.Status !== "Booked"
        );

        loadCSV(logsURL, logsData => {
          bookedSlots = logsData
            .filter(log => log.Date === selectedDate)
            .map(log => log.Time);

          showAvailableSlots();
        });
      });
    }

    function showAvailableSlots() {
      const container = document.getElementById("slotList");
      container.innerHTML = "";

      if (allSlots.length === 0) {
        container.innerHTML = "<p>No slots available.</p>";
        return;
      }

      allSlots.forEach(slot => {
        if (!bookedSlots.includes(slot.Time)) {
          const btn = document.createElement("div");
          btn.className = "slot-item";
          btn.innerHTML = `üïë ${slot.Time} 
            <br><button onclick="bookNow('${slot.Date}', '${slot.Time}')">Book Now</button>`;
          container.appendChild(btn);
        }
      });
    }

    function bookNow(date, time) {
      const patientName = prompt("Enter your name:");
      const reason = prompt("Reason for visit:");

      if (patientName && reason) {
        const message = `Appointment Request:\nüë§ Name: ${patientName}\nüè• Clinic: ${clinic}\nüìÖ Date: ${date}\n‚è∞ Time: ${time}\nüìù Reason: ${reason}`;
        const whatsappURL = `https://wa.me/919390664577?text=${encodeURIComponent(message)}`;
        window.location.href = whatsappURL;
      } else {
        alert("Booking cancelled. Please provide name and reason.");
      }
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</body>
</html>
