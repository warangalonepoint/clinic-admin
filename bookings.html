<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book Appointment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      background-color: black;
      font-family: sans-serif;
      color: white;
      padding: 20px;
    }

    h2 {
      color: #00e699;
    }

    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }

    button {
      background-color: #00e699;
      color: black;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>ðŸ“… Book Your Appointment</h2>
  
  <input type="text" id="name" placeholder="Enter Your Name" />
  <input type="text" id="reason" placeholder="Reason for Visit" />

  <label for="date">Select Date</label>
  <select id="date"></select>

  <label for="slot">Select Time Slot</label>
  <select id="slot">
    <option>-- Select Time Slot --</option>
  </select>

  <button onclick="confirmBooking()">Book on WhatsApp</button>

  <script>
    const SLOTS_URL = 'https://warangalonepoint.github.io/clinic-admin/Slots.csv';
    const LOGS_URL = 'https://warangalonepoint.github.io/clinic-admin/logs.csv';

    let allSlots = [];
    let bookedSlots = [];

    async function loadData() {
      const [slotsText, logsText] = await Promise.all([
        fetch(SLOTS_URL).then(res => res.text()),
        fetch(LOGS_URL).then(res => res.text())
      ]);

      allSlots = parseCSV(slotsText);
      bookedSlots = parseCSV(logsText);

      const dates = [...new Set(allSlots.map(row => row.Date))];
      const dateSelect = document.getElementById("date");
      dates.forEach(date => {
        const opt = document.createElement("option");
        opt.value = date;
        opt.textContent = date;
        dateSelect.appendChild(opt);
      });

      dateSelect.addEventListener("change", updateSlots);
    }

    function updateSlots() {
      const selectedDate = document.getElementById("date").value;
      const slotSelect = document.getElementById("slot");
      slotSelect.innerHTML = '<option>-- Select Time Slot --</option>';

      const available = allSlots.filter(
        row => row.Date === selectedDate && row.Status.toLowerCase() === "available"
      );

      const booked = bookedSlots
        .filter(row => row.Date === selectedDate)
        .map(row => row.Time);

      const filtered = available.filter(slot => !booked.includes(slot.Time));

      filtered.forEach(slot => {
        const opt = document.createElement("option");
        opt.value = slot.Time;
        opt.textContent = slot.Time;
        slotSelect.appendChild(opt);
      });
    }

    function confirmBooking() {
      const name = document.getElementById("name").value.trim();
      const reason = document.getElementById("reason").value.trim();
      const date = document.getElementById("date").value;
      const slot = document.getElementById("slot").value;

      if (!name || !reason || !date || slot.includes("Select")) {
        alert("Please fill all fields properly.");
        return;
      }

      const msg = `Hi, I would like to book an appointment.\n\nName: ${name}\nReason: ${reason}\nDate: ${date}\nTime: ${slot}`;
      const url = `https://wa.me/919390664577?text=${encodeURIComponent(msg)}`;
      window.location.href = url;
    }

    function parseCSV(text) {
      const [header, ...rows] = text.trim().split("\n");
      const keys = header.split(",");
      return rows.map(row => {
        const values = row.split(",");
        const obj = {};
        keys.forEach((key, i) => obj[key.trim()] = values[i]?.trim());
        return obj;
      });
    }

    loadData();
  </script>
</body>
</html>
