<script>
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQyTuU2qw0Yxk6GKRdpbzWtoYcKJy2nfVcq294q0aSpyCsntFJ01FKjigBAesiC7g8cCbEK_lUWVdr/pub?gid=1762577234&single=true&output=csv';

  const dateSelect = document.getElementById("date-select");
  const slotSelect = document.getElementById("slot-select");
  const bookBtn = document.getElementById("book-btn");

  let slotData = {}; // { '2025-07-28': [ '09:00 AM', '09:10 AM', ... ] }

  function convertSerialToDate(serial) {
    const excelEpoch = new Date(1899, 11, 30);
    const date = new Date(excelEpoch.getTime() + serial * 86400000);
    return date.toISOString().split("T")[0]; // "YYYY-MM-DD"
  }

  function loadSlots() {
    fetch(sheetUrl)
      .then(res => res.text())
      .then(csv => {
        const lines = csv.trim().split("\n").slice(1); // remove headers
        lines.forEach(line => {
          const [serialDate, time, status] = line.split(",");
          if (status && status.trim().toLowerCase() === "available") {
            const readableDate = convertSerialToDate(parseInt(serialDate));
            if (!slotData[readableDate]) {
              slotData[readableDate] = [];
            }
            slotData[readableDate].push(time.trim());
          }
        });

        populateDates();
      });
  }

  function populateDates() {
    dateSelect.innerHTML = `<option value="">Select a Date</option>`;
    Object.keys(slotData).forEach(date => {
      const opt = document.createElement("option");
      opt.value = date;
      opt.textContent = date;
      dateSelect.appendChild(opt);
    });

    // Disable slotSelect until date is picked
    slotSelect.innerHTML = `<option>Select a date first</option>`;
    slotSelect.disabled = true;
  }

  dateSelect.addEventListener("change", () => {
    const selectedDate = dateSelect.value;
    const slots = slotData[selectedDate] || [];

    slotSelect.innerHTML = "";
    if (slots.length > 0) {
      slots.forEach(slot => {
        const opt = document.createElement("option");
        opt.value = slot;
        opt.textContent = slot;
        slotSelect.appendChild(opt);
      });
      slotSelect.disabled = false;
    } else {
      slotSelect.innerHTML = `<option>No slots available</option>`;
      slotSelect.disabled = true;
    }
  });

  bookBtn.addEventListener("click", () => {
    const selectedDate = dateSelect.value;
    const selectedSlot = slotSelect.value;

    if (!selectedDate || !selectedSlot || slotSelect.disabled) {
      alert("Please select both date and slot.");
      return;
    }

    const encodedMsg = encodeURIComponent(
      `Hi, I would like to book an appointment on ${selectedDate} at ${selectedSlot}`
    );
    const waUrl = `https://wa.me/919390664577?text=${encodedMsg}`;
    window.open(waUrl, "_blank");
  });

  loadSlots();
</script>
