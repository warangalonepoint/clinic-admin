<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clinic Booking</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #00ffc8;
    }
    select, input, button {
      font-size: 16px;
      margin: 10px;
      padding: 10px;
      width: 80%;
      max-width: 400px;
    }
    .status {
      margin-top: 10px;
      font-weight: bold;
    }
    .status.success {
      color: #00ff80;
    }
    .status.error {
      color: #ff4d4d;
    }
  </style>
</head>
<body>
  <h1>Book Your Appointment</h1>

  <select id="slotSelect">
    <option disabled selected>Loading available slots...</option>
  </select><br>

  <input type="text" id="patientName" placeholder="Your Name" required><br>
  <input type="text" id="reason" placeholder="Reason for Visit (optional)"><br>

  <button onclick="checkAndBook()">Confirm & Book</button>

  <div class="status" id="statusMsg"></div>

  <script>
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQyTuU2qw0Yxk6GKRdpbzWtoYcKJy2nfVcq294q0aSpyCsntFJ01FKjigBAesiC7g8cCbEK_lUWVdr/pub?gid=0&single=true&output=csv';
    let slots = [];

    async function loadSlots() {
      const res = await fetch(sheetURL);
      const text = await res.text();
      const rows = text.trim().split('\n').slice(1).map(row => row.split(','));

      slots = rows.filter(r => r[2]?.toLowerCase() === 'available');

      const slotSelect = document.getElementById('slotSelect');
      slotSelect.innerHTML = '';

      if (slots.length === 0) {
        slotSelect.innerHTML = '<option>No available slots</option>';
        return;
      }

      slots.forEach(([date, time]) => {
        const option = document.createElement('option');
        option.value = `${date} ${time}`;
        option.textContent = `${date} - ${time}`;
        slotSelect.appendChild(option);
      });
    }

    async function checkAndBook() {
      const name = document.getElementById('patientName').value.trim();
      const reason = document.getElementById('reason').value.trim();
      const slotVal = document.getElementById('slotSelect').value;
      const statusMsg = document.getElementById('statusMsg');
      statusMsg.textContent = '';
      statusMsg.className = 'status';

      if (!slotVal || !name) {
        statusMsg.textContent = 'Please fill all required fields.';
        statusMsg.classList.add('error');
        return;
      }

      const [selectedDate, selectedTime] = slotVal.split(' - ');
      await loadSlots();
      const isStillAvailable = slots.some(([date, time]) =>
        `${date} ${time}` === slotVal && time
      );

      if (!isStillAvailable) {
        statusMsg.textContent = 'Slot no longer available. Please refresh.';
        statusMsg.classList.add('error');
        return;
      }

      statusMsg.textContent = 'Slot confirmed. Redirecting...';
      statusMsg.classList.add('success');

      const message = `Hello, I would like to book an appointment.\n\nüìÖ Date: ${selectedDate}\n‚è∞ Time: ${selectedTime}\nüë§ Name: ${name}\nüìù Reason: ${reason || 'Not specified'}`;
      const encoded = encodeURIComponent(message);
      window.location.href = `https://wa.me/919390664577?text=${encoded}`;
    }

    loadSlots();
  </script>
</body>
</html>
